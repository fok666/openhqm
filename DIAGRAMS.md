# OpenHQM System Diagrams

## Request Flow Sequence Diagram

```
┌──────┐                ┌─────────┐              ┌───────┐              ┌────────┐              ┌──────────┐
│Client│                │   API   │              │ Queue │              │ Worker │              │  Cache   │
└──┬───┘                └────┬────┘              └───┬───┘              └───┬────┘              └────┬─────┘
   │                         │                       │                      │                        │
   │  POST /api/v1/submit    │                       │                      │                        │
   │────────────────────────>│                       │                      │                        │
   │                         │                       │                      │                        │
   │                         │ Generate correlation_id                      │                        │
   │                         │───────────────────────                       │                        │
   │                         │                       │                      │                        │
   │                         │  Store metadata       │                      │                        │
   │                         │──────────────────────────────────────────────────────────────────────>│
   │                         │                       │                      │                        │
   │                         │  Publish request      │                      │                        │
   │                         │──────────────────────>│                      │                        │
   │                         │                       │                      │                        │
   │ 202 ACCEPTED            │                       │                      │                        │
   │<────────────────────────│                       │                      │                        │
   │ {correlation_id}        │                       │                      │                        │
   │                         │                       │                      │                        │
   │                         │                       │  Consume message     │                        │
   │                         │                       │<─────────────────────│                        │
   │                         │                       │                      │                        │
   │                         │                       │                      │  Update status         │
   │                         │                       │                      │───────────────────────>│
   │                         │                       │                      │                        │
   │                         │                       │                      │  Process payload       │
   │                         │                       │                      │─────────────           │
   │                         │                       │                      │             │          │
   │                         │                       │                      │<────────────           │
   │                         │                       │                      │                        │
   │                         │                       │  Publish response    │                        │
   │                         │                       │<─────────────────────│                        │
   │                         │                       │                      │                        │
   │                         │                       │                      │  Store result          │
   │                         │                       │                      │───────────────────────>│
   │                         │                       │                      │                        │
   │                         │                       │  Acknowledge         │                        │
   │                         │                       │<─────────────────────│                        │
   │                         │                       │                      │                        │
   │  GET /api/v1/response/{id}                     │                      │                        │
   │────────────────────────>│                       │                      │                        │
   │                         │                       │                      │                        │
   │                         │  Get result           │                      │                        │
   │                         │──────────────────────────────────────────────────────────────────────>│
   │                         │                       │                      │                        │
   │ 200 OK                  │                       │                      │                        │
   │<────────────────────────│                       │                      │                        │
   │ {result}                │                       │                      │                        │
   │                         │                       │                      │                        │
```

## Component Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  Client Layer                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ Browser  │  │  Mobile  │  │   CLI    │  │  cURL    │  │ Service  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Load Balancer (Optional)                               │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          ▼                           ▼                           ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   API Instance 1    │    │   API Instance 2    │    │   API Instance N    │
│  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │
│  │   FastAPI     │  │    │  │   FastAPI     │  │    │  │   FastAPI     │  │
│  │   Uvicorn     │  │    │  │   Uvicorn     │  │    │  │   Uvicorn     │  │
│  └───────────────┘  │    │  └───────────────┘  │    │  └───────────────┘  │
│  Port: 8000         │    │  Port: 8000         │    │  Port: 8000         │
└──────────┬──────────┘    └──────────┬──────────┘    └──────────┬──────────┘
           │                          │                           │
           └──────────────────────────┼───────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Redis Cache Layer                                   │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  • Request metadata (status, timestamps)                               │    │
│  │  • Response storage (with TTL)                                         │    │
│  │  • Correlation ID mappings                                             │    │
│  │  • Session data                                                        │    │
│  └────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Message Queue Layer (Redis)                             │
│  ┌──────────────────────────┐           ┌──────────────────────────┐           │
│  │    Request Queue         │           │    Response Queue        │           │
│  │  ┌────────────────────┐  │           │  ┌────────────────────┐  │           │
│  │  │  Redis Streams     │  │           │  │  Redis Streams     │  │           │
│  │  │  Consumer Groups   │  │           │  │                    │  │           │
│  │  └────────────────────┘  │           │  └────────────────────┘  │           │
│  └──────────────────────────┘           └──────────────────────────┘           │
│                                                                                  │
│  ┌──────────────────────────┐                                                   │
│  │    Dead Letter Queue     │                                                   │
│  │  ┌────────────────────┐  │                                                   │
│  │  │  Failed Messages   │  │                                                   │
│  │  └────────────────────┘  │                                                   │
│  └──────────────────────────┘                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          ▼                           ▼                           ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   Worker 1          │    │   Worker 2          │    │   Worker N          │
│  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │
│  │ Message       │  │    │  │ Message       │  │    │  │ Message       │  │
│  │ Consumer      │  │    │  │ Consumer      │  │    │  │ Consumer      │  │
│  └───────┬───────┘  │    │  └───────┬───────┘  │    │  └───────┬───────┘  │
│          │          │    │          │          │    │          │          │
│  ┌───────▼───────┐  │    │  ┌───────▼───────┐  │    │  ┌───────▼───────┐  │
│  │ Business      │  │    │  │ Business      │  │    │  │ Business      │  │
│  │ Logic         │  │    │  │ Logic         │  │    │  │ Logic         │  │
│  │ Processor     │  │    │  │ Processor     │  │    │  │ Processor     │  │
│  └───────────────┘  │    │  └───────────────┘  │    │  └───────────────┘  │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Observability Stack                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Prometheus  │  │   Grafana    │  │   Logs       │  │   Alerts     │      │
│  │   Metrics    │  │  Dashboards  │  │  (structlog) │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## State Transition Diagram

```
                    ┌─────────────────┐
                    │   SUBMITTED     │
                    │  (Initial)      │
                    └────────┬────────┘
                             │
                             │ Worker picks up message
                             │
                             ▼
                    ┌─────────────────┐
                    │   PENDING       │◄───────────┐
                    │  (In Queue)     │            │
                    └────────┬────────┘            │
                             │                     │
                             │ Worker starts       │ Retry on
                             │ processing          │ retryable error
                             │                     │
                             ▼                     │
                    ┌─────────────────┐            │
                    │  PROCESSING     │────────────┘
                    │ (Being worked)  │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
        ┌───────────▼──────┐    ┌────▼────────────┐
        │   COMPLETED      │    │    FAILED       │
        │  (Success)       │    │  (Error)        │
        └──────────────────┘    └─────────────────┘
                                         │
                                         │ After max retries
                                         │
                                         ▼
                                ┌─────────────────┐
                                │   DLQ           │
                                │ (Manual Review) │
                                └─────────────────┘
```

## Deployment Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                         Production Environment                        │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Kubernetes Cluster                        │   │
│  │                                                               │   │
│  │  ┌────────────────────────────────────────────────────┐     │   │
│  │  │          API Deployment (3 replicas)              │     │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐        │     │   │
│  │  │  │  API Pod │  │  API Pod │  │  API Pod │        │     │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘        │     │   │
│  │  └────────────────────┬───────────────────────────────┘     │   │
│  │                       │                                      │   │
│  │                       │                                      │   │
│  │  ┌────────────────────▼───────────────────────────────┐     │   │
│  │  │             Service (LoadBalancer)                 │     │   │
│  │  └────────────────────────────────────────────────────┘     │   │
│  │                       │                                      │   │
│  │                       │                                      │   │
│  │  ┌────────────────────▼───────────────────────────────┐     │   │
│  │  │        Worker Deployment (5 replicas)              │     │   │
│  │  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐              │     │   │
│  │  │  │ W1 │ │ W2 │ │ W3 │ │ W4 │ │ W5 │              │     │   │
│  │  │  └────┘ └────┘ └────┘ └────┘ └────┘              │     │   │
│  │  └────────────────────────────────────────────────────┘     │   │
│  │                                                               │   │
│  │  ┌────────────────────────────────────────────────────┐     │   │
│  │  │         Redis StatefulSet (HA)                     │     │   │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐     │     │   │
│  │  │  │  Master   │  │ Replica 1 │  │ Replica 2 │     │     │   │
│  │  │  └───────────┘  └───────────┘  └───────────┘     │     │   │
│  │  └────────────────────────────────────────────────────┘     │   │
│  │                                                               │   │
│  └───────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              Monitoring Stack                                │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │
│  │  │Prometheus│  │ Grafana  │  │   Loki   │  │AlertMgr │   │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

## Data Flow - Message Processing

```
1. Request Arrival
   ┌──────────┐
   │  Client  │
   └────┬─────┘
        │ HTTP POST
        ▼
   ┌──────────┐
   │   API    │ → Generate UUID
   └────┬─────┘
        │
        ├─→ Cache: Store metadata
        │
        └─→ Queue: Publish message
             {
               "correlation_id": "uuid",
               "payload": {...},
               "timestamp": "...",
               "metadata": {...}
             }

2. Worker Processing
   ┌──────────┐
   │  Queue   │
   └────┬─────┘
        │ Consume
        ▼
   ┌──────────┐
   │  Worker  │
   └────┬─────┘
        │
        ├─→ Cache: Update status → "PROCESSING"
        │
        ├─→ Process business logic
        │
        ├─→ Success?
        │    ├─→ Yes: Publish to response queue
        │    │        Cache: Store result
        │    │        Queue: Acknowledge
        │    │
        │    └─→ No: Retry count < max?
        │         ├─→ Yes: Requeue with backoff
        │         └─→ No: Send to DLQ

3. Response Retrieval
   ┌──────────┐
   │  Client  │
   └────┬─────┘
        │ HTTP GET
        ▼
   ┌──────────┐
   │   API    │
   └────┬─────┘
        │
        └─→ Cache: Get result by correlation_id
             └─→ Return to client
```

---

These diagrams provide a comprehensive visual understanding of the OpenHQM system architecture, data flow, and deployment patterns.
